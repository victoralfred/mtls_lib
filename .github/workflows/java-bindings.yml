name: Java Bindings CI

on:
  push:
    branches: [ main, develop, master ]
    paths:
      - 'bindings/java/**'
      - 'src/**'
      - 'include/**'
      - '.github/workflows/java-bindings.yml'
  pull_request:
    branches: [ main, develop, master ]
    paths:
      - 'bindings/java/**'
      - 'src/**'
      - 'include/**'
      - '.github/workflows/java-bindings.yml'
  workflow_dispatch:

env:
  CMAKE_BUILD_TYPE: Release
  MAVEN_OPTS: -Xmx2g -Xms1g

jobs:
  test-java-bindings:
    name: Test Java Bindings
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        # Java bindings target Java 25 (requires actions/setup-java@v5)
        java-version: ['25']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libssl-dev \
            pkg-config \
            maven

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install cmake openssl@3 pkg-config maven

      - name: Build C library (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DMTLS_BUILD_TESTS=OFF \
            -DMTLS_BUILD_EXAMPLES=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON
          cmake --build . --parallel $(nproc)

      - name: Build C library (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          mkdir -p build
          cd build
          OPENSSL_PREFIX=$(brew --prefix openssl@3)
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DMTLS_BUILD_TESTS=OFF \
            -DMTLS_BUILD_EXAMPLES=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DOPENSSL_ROOT_DIR="${OPENSSL_PREFIX}" \
            -DOPENSSL_INCLUDE_DIR="${OPENSSL_PREFIX}/include" \
            -DOPENSSL_CRYPTO_LIBRARY="${OPENSSL_PREFIX}/lib/libcrypto.dylib" \
            -DOPENSSL_SSL_LIBRARY="${OPENSSL_PREFIX}/lib/libssl.dylib"
          cmake --build . --parallel $(sysctl -n hw.ncpu)

      - name: Set library path (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/build" >> $GITHUB_ENV
          echo "LIBRARY_PATH=${{ github.workspace }}/build" >> $GITHUB_ENV

      - name: Set library path (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          OPENSSL_PREFIX=$(brew --prefix openssl@3)
          echo "DYLD_LIBRARY_PATH=${{ github.workspace }}/build:${OPENSSL_PREFIX}/lib" >> $GITHUB_ENV
          echo "LIBRARY_PATH=${{ github.workspace }}/build:${OPENSSL_PREFIX}/lib" >> $GITHUB_ENV

      - name: Build JNI native library (Linux)
        if: matrix.os == 'ubuntu-latest'
        working-directory: bindings/java
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/build
          cmake --build . --parallel $(nproc)

      - name: Build JNI native library (macOS)
        if: matrix.os == 'macos-latest'
        working-directory: bindings/java
        run: |
          mkdir -p build
          cd build
          OPENSSL_PREFIX=$(brew --prefix openssl@3)
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/build \
            -DOPENSSL_ROOT_DIR="${OPENSSL_PREFIX}" \
            -DOPENSSL_INCLUDE_DIR="${OPENSSL_PREFIX}/include" \
            -DOPENSSL_CRYPTO_LIBRARY="${OPENSSL_PREFIX}/lib/libcrypto.dylib" \
            -DOPENSSL_SSL_LIBRARY="${OPENSSL_PREFIX}/lib/libssl.dylib"
          cmake --build . --parallel $(sysctl -n hw.ncpu)

      - name: Compile Java sources
        working-directory: bindings/java
        run: |
          mvn clean compile -DskipTests

      - name: Run Java tests
        working-directory: bindings/java
        run: |
          mvn test -Dmaven.test.failure.ignore=true || true
        continue-on-error: true

      - name: Check Java code style
        if: matrix.os == 'ubuntu-latest' && matrix.java-version == '25'
        working-directory: bindings/java
        run: |
          mvn checkstyle:check || true
        continue-on-error: true

      - name: Generate test report
        if: always()
        working-directory: bindings/java
        run: |
          mvn surefire-report:report || true
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: java-test-results-${{ matrix.os }}-jdk${{ matrix.java-version }}
          path: |
            bindings/java/target/surefire-reports/
            bindings/java/target/site/surefire-report.html
          retention-days: 7

  build-java-package:
    name: Build Java Package
    runs-on: ubuntu-latest
    needs: test-java-bindings

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libssl-dev \
            pkg-config \
            maven

      - name: Build C library
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DMTLS_BUILD_TESTS=OFF \
            -DMTLS_BUILD_EXAMPLES=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON
          cmake --build . --parallel $(nproc)

      - name: Set library path
        run: |
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/build" >> $GITHUB_ENV
          echo "LIBRARY_PATH=${{ github.workspace }}/build" >> $GITHUB_ENV

      - name: Build JNI native library
        working-directory: bindings/java
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/build
          cmake --build . --parallel $(nproc)

      - name: Package with Maven
        working-directory: bindings/java
        run: |
          mvn clean package -DskipTests

      - name: Upload JAR artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: mtls-java-jar-${{ github.sha }}
          path: bindings/java/target/*.jar
          retention-days: 30

      - name: Generate JavaDoc
        working-directory: bindings/java
        run: |
          mvn javadoc:javadoc

      - name: Upload JavaDoc
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: mtls-java-javadoc-${{ github.sha }}
          path: bindings/java/target/site/apidocs/
          retention-days: 30

  build-java-examples:
    name: Build Java Examples
    runs-on: ubuntu-latest
    needs: test-java-bindings

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libssl-dev \
            pkg-config \
            maven

      - name: Build C library
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DMTLS_BUILD_TESTS=OFF \
            -DMTLS_BUILD_EXAMPLES=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON
          cmake --build . --parallel $(nproc)

      - name: Build JNI library
        working-directory: bindings/java
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_PREFIX_PATH=${{ github.workspace }}/build
          cmake --build . --parallel $(nproc)

      - name: Compile Java bindings
        working-directory: bindings/java
        run: |
          mvn clean compile -DskipTests

      - name: Compile examples
        working-directory: bindings/java
        run: |
          javac -cp target/classes examples/*.java

      - name: Create example scripts
        working-directory: bindings/java
        run: |
          cat > run-client.sh << 'EOF'
          #!/bin/bash
          java -Djava.library.path=build -cp target/classes:examples SimpleClient "$@"
          EOF

          cat > run-server.sh << 'EOF'
          #!/bin/bash
          java -Djava.library.path=build -cp target/classes:examples SimpleServer "$@"
          EOF

          chmod +x run-client.sh run-server.sh

      - name: Upload example binaries
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: java-examples-${{ github.sha }}
          path: |
            bindings/java/examples/*.class
            bindings/java/run-*.sh
          retention-days: 7

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run SpotBugs
        working-directory: bindings/java
        run: |
          mvn spotbugs:check || true
        continue-on-error: true

      - name: Run PMD
        working-directory: bindings/java
        run: |
          mvn pmd:check || true
        continue-on-error: true

      - name: Check dependencies
        working-directory: bindings/java
        run: |
          mvn dependency:analyze || true
        continue-on-error: true

  summary:
    name: Java Bindings Summary
    runs-on: ubuntu-latest
    needs: [test-java-bindings, build-java-package, build-java-examples, code-quality]
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "## Java Bindings Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test-java-bindings.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Build | ${{ needs.build-java-package.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Examples Build | ${{ needs.build-java-examples.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Matrix" >> $GITHUB_STEP_SUMMARY
          echo "- OS: ubuntu-latest, macos-latest" >> $GITHUB_STEP_SUMMARY
          echo "- JDK Versions: 25" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- JAR package: Available for download" >> $GITHUB_STEP_SUMMARY
          echo "- JavaDoc: Available for download" >> $GITHUB_STEP_SUMMARY
          echo "- Example binaries: Available for download" >> $GITHUB_STEP_SUMMARY
